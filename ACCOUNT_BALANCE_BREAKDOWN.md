# Разделение баланса счета - доступно и в целях

## 🎯 Задача

Добавить на карточку счета отображение "доступно" и "в целях", когда к счету привязаны цели. Показывать сколько денег доступно для трат, а сколько зарезервировано в целях.

## 📊 Пример работы

### **Ситуация:**
- На счету: **1000 ₽**
- Цель: **1000 ₽**
- Отложено в цель: **500 ₽**

### **Отображение на карточке:**
```
┌─────────────────────────────┐
│ [💼] Основной счет          │
│                     1000 ₽  │ ← Общий баланс
│                             │
│           доступно: 500 ₽   │ ← Доступно для трат
│            в целях: 500 ₽   │ ← Зарезервировано
└─────────────────────────────┘
```

## ✅ Реализованные изменения

### **1. Логика расчета доступного баланса**

```typescript
// Получаем сумму зарезервированную в накоплениях для данного счета
const getReservedAmount = () => {
  if (account.type === 'savings') return 0;
  const linkedSavings = accounts.filter(acc => 
    acc.type === 'savings' && acc.linkedAccountId === account.id
  );
  return linkedSavings.reduce((sum, saving) => sum + (saving.savedAmount || 0), 0);
};

// Доступный баланс = Общий баланс - Зарезервированный в целях
const availableBalance = account.balance - getReservedAmount();
```

### **2. Обновленное отображение**

**До (было только):**
```jsx
{getBalanceDisplay(account.balance, true)}
{getReservedAmount() > 0 && (
  <Text style={{ fontSize: 12, color: colors.textSecondary, marginTop: 2 }}>
    {formatBalance(getReservedAmount())} {t('accounts.inSavings')}
  </Text>
)}
```

**После (стало):**
```jsx
{getBalanceDisplay(account.balance, true)}
{getReservedAmount() > 0 ? (
  <View style={{ alignItems: 'flex-end', marginTop: 4 }}>
    <Text style={{ fontSize: 12, color: colors.textSecondary }}>
      {t('accounts.available')}: {formatBalance(account.balance - getReservedAmount())}
    </Text>
    <Text style={{ fontSize: 12, color: colors.textSecondary, marginTop: 1 }}>
      {t('accounts.inGoals')}: {formatBalance(getReservedAmount())}
    </Text>
  </View>
) : null}
```

### **3. Новые строки локализации**

```typescript
// src/locales/ru.ts
accounts: {
  // ...
  available: 'доступно',      // ← Новое
  inGoals: 'в целях',         // ← Новое
  inSavings: 'в накоплениях', // ← Существующее (для целей-накоплений)
  // ...
}
```

## 🔍 Детали реализации

### **1. Условия отображения**

**Показывается разбивка, ТОЛЬКО если:**
- `getReservedAmount() > 0` - есть привязанные цели
- `account.type !== 'credit'` - не кредитный счет
- `account.type !== 'savings'` - не сама цель

**Не показывается для:**
- Обычных счетов без целей
- Кредитных счетов
- Самих целей (у них своя логика отображения)

### **2. Расчет зарезервированной суммы**

```typescript
const getReservedAmount = () => {
  if (account.type === 'savings') return 0; // Сами цели не резервируют
  
  // Находим все цели, привязанные к этому счету
  const linkedSavings = accounts.filter(acc => 
    acc.type === 'savings' && acc.linkedAccountId === account.id
  );
  
  // Суммируем все отложенные в целях суммы
  return linkedSavings.reduce((sum, saving) => 
    sum + (saving.savedAmount || 0), 0
  );
};
```

### **3. Стилизация**

```jsx
<View style={{ alignItems: 'flex-end', marginTop: 4 }}>
  {/* Доступно */}
  <Text style={{ fontSize: 12, color: colors.textSecondary }}>
    {t('accounts.available')}: {formatBalance(availableAmount)}
  </Text>
  
  {/* В целях */}
  <Text style={{ fontSize: 12, color: colors.textSecondary, marginTop: 1 }}>
    {t('accounts.inGoals')}: {formatBalance(reservedAmount)}
  </Text>
</View>
```

## 📱 Визуальное представление

### **Карточка без целей (как раньше):**
```
┌─────────────────────────────┐
│ [💼] Основной счет          │
│                     1000 ₽  │
└─────────────────────────────┘
```

### **Карточка с целями (новое):**
```
┌─────────────────────────────┐
│ [💼] Основной счет          │
│                     1000 ₽  │ ← Общий баланс
│                             │
│           доступно: 500 ₽   │ ← Новое: доступно для трат
│            в целях: 500 ₽   │ ← Новое: зарезервировано
└─────────────────────────────┘
```

### **Карточка с несколькими целями:**
```
┌─────────────────────────────┐
│ [💼] Основной счет          │
│                     2000 ₽  │ ← Общий баланс
│                             │
│           доступно: 200 ₽   │ ← 2000 - (500 + 800 + 500)
│            в целях: 1800 ₽  │ ← Сумма всех целей
└─────────────────────────────┘
```

## 🎯 Логика работы с разными типами счетов

### **1. Обычные счета (cash, card, bank)**
- ✅ Показывают общий баланс
- ✅ Показывают доступно/в целях (если есть цели)

### **2. Кредитные счета**
- ✅ Показывают "Осталось выплатить"
- ❌ НЕ показывают доступно/в целях

### **3. Цели (savings)**
- ✅ Показывают прогресс-бар
- ✅ Показывают накоплено/цель
- ❌ НЕ показывают доступно/в целях (сами являются резервом)

## 🧮 Примеры расчетов

### **Пример 1: Одна цель**
```
Счет: 1000 ₽
Цель "Отпуск": накоплено 300 ₽

Результат:
- Общий баланс: 1000 ₽
- Доступно: 700 ₽  (1000 - 300)
- В целях: 300 ₽
```

### **Пример 2: Несколько целей**
```
Счет: 2000 ₽
Цель "Отпуск": накоплено 500 ₽
Цель "Машина": накоплено 800 ₽
Цель "Телефон": накоплено 200 ₽

Результат:
- Общий баланс: 2000 ₽
- Доступно: 500 ₽  (2000 - 1500)
- В целях: 1500 ₽  (500 + 800 + 200)
```

### **Пример 3: Переотложено (больше цели, чем на счету)**
```
Счет: 1000 ₽
Цель "Отпуск": накоплено 1200 ₽

Результат:
- Общий баланс: 1000 ₽
- Доступно: -200 ₽  (1000 - 1200)
- В целях: 1200 ₽

⚠️ В этом случае доступно может быть отрицательным
```

## 🧪 Тестирование

### **Проверить отображение:**

1. **Создайте обычный счет** с балансом 1000 ₽
2. **Создайте цель**, привязанную к этому счету
3. **Отложите 300 ₽** в цель
4. **Проверьте карточку счета:**
   - Общий баланс: 1000 ₽
   - Доступно: 700 ₽
   - В целях: 300 ₽

### **Проверить разные сценарии:**

1. **Счет без целей** → только общий баланс
2. **Счет с одной целью** → баланс + разбивка
3. **Счет с несколькими целями** → баланс + сумма всех целей
4. **Кредитный счет с целями** → только "осталось выплатить"

## 📁 Файлы

### **Изменены:**
1. **src/components/AccountCard.tsx** - добавлена логика отображения доступного/зарезервированного баланса
2. **src/locales/ru.ts** - добавлены строки `available` и `inGoals`

### **Создано:**
1. **ACCOUNT_BALANCE_BREAKDOWN.md** - документация разделения баланса

---

**Статус**: ✅ **Завершено**

Теперь карточки счетов показывают не только общий баланс, но и разбивку на "доступно" и "в целях", когда к счету привязаны цели. Это помогает пользователю понимать, сколько денег он может тратить, а сколько уже зарезервировано для достижения целей.
