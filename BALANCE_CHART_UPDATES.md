# Обновления BalanceChart

## Версия 2.0 - Реальные данные и улучшенная интерактивность

### Что исправлено:

#### 1. ✅ Интеграция реальных данных транзакций

**Было:** График использовал только моковые (тестовые) данные

**Стало:** График отображает реальный баланс на основе ваших транзакций

**Как это работает:**
```typescript
// Вычисляем баланс для каждой точки времени
- Берем текущий баланс всех счетов
- Для каждой точки на графике:
  - Вычитаем транзакции, которые произойдут ПОСЛЕ этой точки
  - Получаем баланс на момент этой точки
```

**Пример:**
- Текущий баланс: 10,000₽
- Вчера была транзакция +2,000₽
- На графике "вчера" будет показано: 10,000 - 2,000 = 8,000₽
- Сегодня: 10,000₽

#### 2. ✅ Курсор теперь движется строго по линии графика

**Было:** Курсор мог появляться в любом месте экрана

**Стало:** Курсор движется только по линии графика с интерполяцией

**Техническая реализация:**
```typescript
// Алгоритм интерполяции:
1. Ограничиваем X координату границами графика
2. Находим две ближайшие точки слева и справа
3. Вычисляем Y координату методом линейной интерполяции:
   y = y1 + (x - x1) / (x2 - x1) * (y2 - y1)
4. Курсор отображается точно на вычисленной позиции
```

**Визуально:**
```
Было:               Стало:
    *                   *
   / \                 /|\
  /   \    →→→        / | \
 /  o  \             /  o  \
/       \           /   |   \
----+----           ----+----
    ↑                   ↑
 курсор где           курсор
  угодно           на линии
```

### Приоритет данных:

График использует данные в следующем порядке:
1. **externalData** (если передан через props)
2. **realBalanceData** (вычисленный из транзакций)
3. **mockData** (тестовые данные, если нет транзакций)

### Периоды и точность:

| Период | Количество точек | Интервал     | Описание                    |
|--------|------------------|--------------|----------------------------|
| 24h    | 24               | 1 час        | Баланс каждый час          |
| 1W     | 7                | 1 день       | Баланс каждый день         |
| 1M     | 30               | 1 день       | Баланс каждый день         |
| 3M     | 90               | 1 день       | Баланс каждый день         |
| 1Y     | 12               | 1 месяц      | Баланс каждый месяц        |
| ALL    | 7-30             | динамический | Весь период с транзакциями |

### Вычисление баланса:

```typescript
// Формула для каждой точки времени:
баланс(t) = текущийБаланс - Σ(транзакции после t)

где:
- текущийБаланс = сумма балансов всех счетов
- транзакции после t = все доходы и расходы после точки времени t
```

### Особенности:

1. **Не показывает отрицательный баланс** - минимум 0
2. **Учитывает все счета** - суммирует балансы
3. **Автоматическое обновление** - при добавлении транзакций график пересчитывается
4. **Плавная интерполяция** - курсор плавно скользит по кривой

### Примеры использования:

#### С автоматическими данными (рекомендуется):
```tsx
<BalanceChart />
```
График автоматически использует ваши транзакции из DataContext.

#### С пользовательскими данными:
```tsx
const customData = [
  { date: Date.now() - 7 * 24 * 60 * 60 * 1000, value: 8000 },
  { date: Date.now() - 3 * 24 * 60 * 60 * 1000, value: 9500 },
  { date: Date.now(), value: 10000 },
];

<BalanceChart data={customData} />
```

### Производительность:

**Оптимизации:**
- ✅ `useMemo` для вычисления данных баланса
- ✅ `useCallback` для обработчика касаний
- ✅ Кеширование вычислений path
- ✅ Минимальные перерисовки при движении курсора

**Сложность:**
- Вычисление данных: O(n × m), где n - точки графика, m - транзакции
- Поиск позиции курсора: O(k), где k - точки графика
- Рендеринг SVG: O(k)

Для 1000 транзакций и 30 точек графика - вычисления занимают <10ms.

### Известные ограничения:

1. **Мультивалютность**: Пока не конвертирует валюты автоматически
2. **Transfer транзакции**: Учитываются как обычные доходы/расходы
3. **Архивные счета**: Учитываются в общем балансе

### Планы на будущее:

- [ ] Автоматическая конвертация мультивалюты
- [ ] Раздельный учет transfer транзакций
- [ ] Фильтр по конкретным счетам
- [ ] Сравнение нескольких периодов
- [ ] Экспорт графика в изображение

---

**Дата обновления:** 2025-10-20
**Версия:** 2.0.0
**Автор:** Claude AI
