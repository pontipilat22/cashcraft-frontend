# Реализация функциональности кредитов

## 1. База данных и модели

### 1.1 Схема БД
- [x] Добавить таблицу `credit_payment_schedules` в schema.ts (версия 5)
- [x] Создать миграцию с версии 4 на 5
- [x] Добавить недостающие поля в таблицу accounts для кредитов (уже есть)

### 1.2 Модели WatermelonDB
- [x] Создать модель CreditPaymentSchedule (`src/database/models/CreditPaymentSchedule.ts`)
- [x] Обновить модель Account для работы с графиком платежей (relations добавлены)
- [x] Добавить relations между Account и CreditPaymentSchedule
- [x] Обновить `src/database/index.ts` с новой моделью

### 1.3 TypeScript типы
- [x] Добавить интерфейс CreditPaymentSchedule в `src/types/index.ts`
- [x] Добавить типы для статусов платежей (CreditPaymentStatus)
- [x] Добавить типы для операций с кредитом (CreditStatus)

## 2. Сервисы и логика расчётов

### 2.1 Сервис расчёта графика платежей
- [x] Создать `src/services/CreditCalculationService.ts`
  - [x] Функция расчёта аннуитетного платежа
  - [x] Функция расчёта дифференцированного платежа
  - [x] Функция генерации полного графика платежей
  - [x] Функция расчёта дат платежей от даты выдачи
  - [x] Округление сумм до 2 знаков
  - [x] Корректировка последнего платежа (остаток = 0)

### 2.2 Сервис операций с кредитом
- [ ] Создать `src/services/CreditOperationsService.ts`
  - [ ] Отметить обычный платёж (полная сумма)
  - [ ] Частичный платёж
  - [ ] Досрочное погашение (с пересчётом графика)
  - [ ] Добавление платежа задним числом
  - [ ] Автоопределение просрочек
  - [ ] Обновление статусов платежей
  - [ ] Обновление остатка долга в Account

### 2.3 Интеграция с LocalDatabaseService
- [ ] Добавить методы для работы с графиком платежей
  - [ ] createPaymentSchedule
  - [ ] updatePaymentScheduleItem
  - [ ] getPaymentScheduleForAccount
  - [ ] deletePaymentSchedule

## 3. UI Компоненты

### 3.1 Экран деталей кредита
- [x] Создать `src/screens/CreditDetailsScreen.tsx`
  - [x] Шапка с основной информацией
    - [x] Остаток долга (крупно)
    - [x] Сумма выплачено
    - [x] Всего к выплате
    - [x] Процент выплат
  - [x] Прогресс-бар выплат
  - [x] Карточка ближайшего платежа
    - [x] Дата платежа
    - [x] Сумма платежа
    - [ ] Дней до платежа / просрочка (базово реализовано)
  - [ ] Статусы кредита (активный, просрочен, погашен, архивный) (частично)

### 3.2 Компонент визуального графика
- [ ] Создать `src/components/CreditBalanceChart.tsx`
  - [ ] График остатка долга по времени (линейный график)
  - [ ] Использовать react-native-svg и d3-shape
  - [ ] Отметки на графике для платежей
  - [ ] Интерактивность (показ деталей при клике)
  - [ ] Градиентная заливка под линией

### 3.3 Компонент таблицы платежей
- [x] Создать список платежей в CreditDetailsScreen (встроен в экран)
  - [x] Список строк платежей
  - [x] Столбцы: дата, общий платёж, проценты, тело, остаток
  - [x] Статусы строк (pending, paid, overdue, partial)
  - [x] Цветовая индикация статусов
  - [ ] Возможность отметить платёж (кнопка/свайп) (кнопка добавлена, логика TODO)

### 3.4 Модальные окна операций
- [ ] Создать `src/components/CreditPaymentModal.tsx`
  - [ ] Форма для отметки обычного платежа
  - [ ] Форма для частичного платежа
  - [ ] Выбор даты платежа
  - [ ] Выбор счёта для списания

- [ ] Создать `src/components/CreditEarlyRepaymentModal.tsx`
  - [ ] Ввод суммы досрочного погашения
  - [ ] Выбор даты
  - [ ] Выбор счёта
  - [ ] Показ нового графика после досрочного погашения

### 3.5 Форма создания/редактирования кредита
- [ ] Обновить существующую форму создания счёта
  - [ ] Валидация обязательных полей для кредита
    - [ ] Сумма кредита
    - [ ] Дата выдачи
    - [ ] Срок (месяцы) или дата окончания
    - [ ] Годовая ставка
    - [ ] Тип платежей (аннуитет/дифференцированный)
  - [ ] Опциональные поля
    - [ ] Валюта
    - [ ] Счёт для списания платежей
    - [ ] Дата первого платежа (если отличается от даты выдачи + месяц)
  - [ ] Автоматический расчёт графика при создании

## 4. Навигация

- [x] Добавить CreditDetailsScreen в навигацию
  - [x] Обновить типы навигации в AccountsNavigator
  - [x] Добавить переход при клике на карточку кредита
  - [x] Передача accountId в параметрах

## 5. Логика статусов и напоминаний

### 5.1 Статусы кредита
- [ ] Реализовать вычисление статуса
  - [ ] Активный (есть непогашенные платежи, нет просрочек)
  - [ ] Просрочен (есть платежи с датой < сегодня и status = pending)
  - [ ] Погашен (все платежи оплачены, остаток = 0)
  - [ ] Архивный (погашен + помечен как архивный)

### 5.2 Напоминания
- [ ] Настройка напоминаний для кредита
  - [ ] За N дней до платежа
  - [ ] Включить/выключить напоминания
- [ ] Интеграция с системой уведомлений (если есть)

## 6. Синхронизация и производительность

### 6.1 Офлайн работа
- [ ] Все операции работают без сети
- [ ] Данные сохраняются в локальную БД
- [ ] При появлении сети - синхронизация с сервером

### 6.2 Производительность
- [ ] Оптимизация расчёта графика (мемоизация)
- [ ] Виртуализация списка платежей для больших сроков (120+ месяцев)
- [ ] Lazy loading данных графика

### 6.3 Разрешение конфликтов
- [ ] При синхронизации - приоритет последней правки по времени
- [ ] Логирование конфликтов для анализа

## 7. Обработка ошибок и пустых состояний

- [ ] Кредит не найден - сообщение пользователю
- [ ] График пуст - пояснение почему (нет обязательных полей)
- [ ] Ошибки расчёта - валидация входных данных
- [ ] Ошибки БД - graceful degradation

## 8. Форматирование и локализация

- [ ] Форматирование сумм с валютой кредита
- [ ] Форматирование дат в локальном формате
- [ ] Единый формат везде (использовать useCurrency и useLocalization)
- [ ] Добавить переводы в `src/localization/` для всех языков
  - [ ] Русский
  - [ ] Английский
  - [ ] Остальные языки

## 9. Тестирование

- [ ] Тестирование логики расчётов
  - [ ] Аннуитетный платёж
  - [ ] Дифференцированный платёж
  - [ ] Досрочное погашение
  - [ ] Граничные случаи (0%, очень большие сроки)

- [ ] Тестирование UI
  - [ ] Отображение данных
  - [ ] Операции с платежами
  - [ ] Навигация

## 10. Документация

- [ ] Обновить README с описанием функциональности кредитов
- [ ] Документировать API сервисов
- [ ] Примеры использования

---

## Прогресс: 28/100+ задач выполнено

### Основные достижения:
✅ База данных и миграции
✅ Модели WatermelonDB
✅ TypeScript типы
✅ Сервис расчёта графика платежей (полностью)
✅ Базовый экран деталей кредита
✅ Навигация к экрану
✅ Список платежей с деталями
✅ Автоматическая генерация и сохранение графика

### Что осталось:
🔄 Операции с платежами (отметка, досрочное погашение)
🔄 Визуальный график остатка долга
🔄 Модальные окна для операций
🔄 Система напоминаний
🔄 Локализация
🔄 Тестирование

Последнее обновление: 2025-10-20
