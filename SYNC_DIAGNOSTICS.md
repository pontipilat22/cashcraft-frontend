# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:

1. **`sync.upload`** - –æ—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
2. **`sync.download`** - –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞  
3. **`importCloudData`** - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ª–æ–∫–∞–ª—å–Ω–æ

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è downloadData

–ú–µ—Ç–æ–¥ `downloadData` —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `lastSyncAt` –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã:
- –ï—Å–ª–∏ `cloudData.lastSyncAt === localLastSync` - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∏–º–ø–æ—Ä—Ç
- –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ - –æ—á–∏—â–∞–µ—Ç –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç

## –ü—Ä–æ–±–ª–µ–º–∞
`CloudSyncService.syncData` –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ª–∏ syncData
```javascript
// –í DataContext.tsx –µ—Å—Ç—å –≤—ã–∑–æ–≤—ã:
await CloudSyncService.syncData(userId, token);
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω
```javascript
const token = await AsyncStorage.getItem('@cashcraft_access_token');
console.log('–¢–æ–∫–µ–Ω:', token ? '–ï—Å—Ç—å' : '–ù–µ—Ç');
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```javascript
const { WatermelonDatabaseService } = await import('./watermelonDatabase');
const unsyncedData = await WatermelonDatabaseService.getUnsyncedData();
console.log('–ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', unsyncedData);
```

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–ª–∞–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
–ù–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å `syncedAt = undefined` (–Ω–µ `null`).

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ getUnsyncedData()
- –¢–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `synced_at` –≤–º–µ—Å—Ç–æ `updated_at`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `Q.or` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ `null` –∑–Ω–∞—á–µ–Ω–∏–π
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ–ª–µ `syncedAt` —Ç–µ–ø–µ—Ä—å —è–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `undefined`:
```javascript
// –í –º–µ—Ç–æ–¥–∞—Ö createAccount, createTransaction, createCategory, createDebt
account.syncedAt = undefined; // –Ø–≤–Ω–æ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π `syncedAt` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ `undefined`:
```javascript
// –í –º–µ—Ç–æ–¥–∞—Ö updateAccount, updateTransaction, updateCategory, updateDebt
acc.syncedAt = undefined; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
```

### 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—è–¥–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
–í `DataContext.initializeApp` —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫:
```javascript
// 1. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
const syncSuccess = await CloudSyncService.syncData(userId, token);
// 2. –ü–æ—Ç–æ–º –∑–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
const hasCloudData = await CloudSyncService.downloadData(userId, token);
```

### 5. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω downloadData
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `lastSyncAt` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–µ–Ω—É–∂–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏:
```javascript
if (cloudData.lastSyncAt === await LocalDatabaseService.getLastSyncTime()) {
  console.log('–î–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ—Ç –Ω–æ–≤—ã—Ö - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–º–ø–æ—Ä—Ç');
  return true;
}
```

### 6. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø–µ—Ä–µ–∑–∞—Ö–æ–¥–æ–º –≤ –∞–∫–∫–∞—É–Ω—Ç
–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞—Ö–æ–¥–µ –≤ –∞–∫–∫–∞—É–Ω—Ç —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞:
```javascript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
const hasLocalData = accountsFromDb.length > 1 || transactionsFromDb.length > 0 || 
                     categoriesFromDb.length > 11 || debtsFromDb.length > 0;

if (hasLocalData) {
  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: upload ‚Üí download
  await CloudSyncService.syncData(userId, token);
  await CloudSyncService.downloadData(userId, token);
} else {
  // –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞—Ö–æ–¥–µ: download ‚Üí upload (—á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ)
  await CloudSyncService.downloadData(userId, token);
  await CloudSyncService.syncData(userId, token);
}
```

### 7. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω wipeData
–ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
```javascript
// 1. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
await fetch('/api/v1/sync/wipe', { method: 'DELETE' });

// 2. –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É
await database.write(async () => {
  // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏
});

// 3. –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å –±–∞–∑–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
await LocalDatabaseService.forceReinitialize('USD');

// 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —Å–±—Ä–æ—Å–∞
await AsyncStorage.setItem(`dataReset_${userId}`, 'true');
```

–≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –±–∞–∑–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:
```bash
node scripts/test-sync.js
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å (—Å—á–µ—Ç/—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é)
2. –ù–∞–∂–º–∏—Ç–µ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å" –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ:
   - `üì§ [DataContext] 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä...`
   - `üì• [DataContext] 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞...`
   - `üìä [WatermelonDatabase] –ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:`
   - `üåê [CloudSync] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:`
   - `POST /api/v1/sync/upload`

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –∏—Å—Ç–µ–∫
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
- –û–±–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω

### 2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –≥–æ—Ç–æ–≤–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `WatermelonDatabaseService.isDatabaseReady()`

### 3. –í—Å–µ –∑–∞–ø–∏—Å–∏ —É–∂–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `getUnsyncedData()` - –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –∏–º–µ—é—Ç `syncedAt = undefined`

### 4. –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞

### 5. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–Ω–∞—á–∞–ª–∞ –∏–¥–µ—Ç `sync.upload`, –ø–æ—Ç–æ–º `sync.download`

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–∏–∫–ª wipeData (–µ—Å–ª–∏ –µ—Å—Ç—å)
node scripts/stop-wipe-cycle.js

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
node scripts/test-sync.js

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
# –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
``` 